<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>YT Downloader</title>
  </head>
  <body>
    <input id="url" type="text" placeholder="https://youtu.be/…" />
    <button onclick="formats()">Get Formats</button>

    <script>
      async function formats() {
        const raw = document.getElementById("url").value
        const videoId = raw.split("?v=").pop()
        const res = await fetch(`/api/formats?v=${videoId}`)
        if (res.status !== 200) return alert("Invalid video ID")
        
        const formats = await res.json()
        const table = document.createElement("table")
        table.innerHTML = `
          <tr>
            <th>Format</th><th>Resolution</th><th>FPS</th><th>Action</th>
          </tr>`
        
        formats.forEach(fmt => {
          const tr = document.createElement("tr")
          tr.innerHTML = `
            <td>${fmt.formatName}</td>
            <td>${fmt.resolution}</td>
            <td>${fmt.fps}</td>
            <td>
              <button onclick="handleDownload('${videoId}','${fmt.id}', this)">
                Download
              </button>
            </td>
          `
          table.appendChild(tr)
        })

        document.body.appendChild(table)
      }

      async function handleDownload(videoId, formatId, btn) {
        const downloadDiv = document.createElement("div")
        document.getElementsByTagName("table")[0].replaceWith(downloadDiv)
        downloadDiv.innerText = "Requesting…"

        const reqRes = await fetch(
          `/api/download/request?v=${videoId}&f=${formatId}`
        )
        if (reqRes.status !== 200) {
          return alert("Failed to start download")
        }

        // Poll /ready until we get a 200
        downloadDiv.innerText = "Waiting for file…"
        const interval = setInterval(async () => {
          const readyRes = await fetch(
            `/api/download/ready?v=${videoId}`
          )
          if (readyRes.status === 200) {
            clearInterval(interval)

            // Show the real download link
            const link = document.createElement("a")
            link.href = `/api/download?v=${videoId}`
            link.download = ""
            link.innerText = "Click here to download!"
            downloadDiv.innerText = ""
            downloadDiv.appendChild(link)
          }
        }, 2000)
      }
    </script>
  </body>
</html>
