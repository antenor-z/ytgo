<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>YT Downloader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
  </head>
  <body class="bg-dark text-light">

    <div class="container py-5">
      <h1 class="mb-4 text-center">A4 Downloader</h1>

      <div class="mb-3">
        <input class="form-control" id="url" type="text" placeholder="link" />
      </div>

      <div class="mb-3">
        <input class="form-control" id="p" type="text" placeholder="Password">
      </div>

      <div class="d-grid gap-2 mb-5">
        <button class="btn btn-primary" onclick="formats()">Get Formats</button>
      </div>

      <div id="output"></div>
    </div>

    <script>
      async function formats() {
        window.p = document.getElementById("p").value
        const raw = document.getElementById("url").value
        const videoId = raw.split("?v=").pop()
        const res = await fetch(`/api/formats?v=${videoId}&p=${window.p}`)
        if (res.status !== 200) return alert("Invalid video ID")
        
        const formats = await res.json()
        const table = document.createElement("table")
        table.className = "table table-striped table-bordered"

        table.innerHTML = `
          <thead class="table-dark">
            <tr>
              <th>Format</th>
              <th>Resolution</th>
              <th>FPS</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        `
        
        formats.forEach(fmt => {
          const tr = document.createElement("tr")
          tr.innerHTML = `
            <td>${fmt.formatName}</td>
            <td>${fmt.resolution}</td>
            <td>${fmt.fps}</td>
            <td>
              <button class="btn btn-success btn-sm" onclick="handleDownload('${videoId}','${fmt.id}', this)">
                Download
              </button>
            </td>
          `
          table.querySelector('tbody').appendChild(tr)
        })

        const outputDiv = document.getElementById("output")
        outputDiv.innerHTML = ""  // Clear previous output
        outputDiv.appendChild(table)
      }

      async function handleDownload(videoId, formatId, btn) {
        const downloadDiv = document.createElement("div")
        downloadDiv.className = "alert alert-info text-center"
        
        document.getElementById("output").innerHTML = ""
        document.getElementById("output").appendChild(downloadDiv)

        downloadDiv.innerText = "Requesting…"

        const reqRes = await fetch(
          `/api/download/request?v=${videoId}&f=${formatId}&p=${window.p}`
        )
        if (reqRes.status !== 200) {
          return alert("Failed to start download")
        }

        // Poll /ready until we get a 200
        downloadDiv.innerText = "Waiting for file…"
        const interval = setInterval(async () => {
          const readyRes = await fetch(
            `/api/download/ready?v=${videoId}&p=${window.p}`
          )
          if (readyRes.status === 200) {
            clearInterval(interval)

            // Show the real download link
            const link = document.createElement("a")
            link.href = `/api/download?v=${videoId}&p=${window.p}`
            link.download = ""
            link.innerText = "Click here to download!"
            link.className = "btn btn-success"

            downloadDiv.innerHTML = ""
            downloadDiv.appendChild(link)
          }
        }, 2000)
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
  </body>
</html>
